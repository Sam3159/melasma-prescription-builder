<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Melasma Prescription Builder</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f4f4f4}
.hidden{display:none!important}
.page{max-width:1200px;margin:18px auto;padding:16px;background:#fff;border-radius:14px}
.btn{border:1px solid #ccc;background:#fff;border-radius:999px;padding:8px 14px;cursor:pointer}
.btn:hover{background:#f1f1f1}
.card{border:1px solid #ddd;border-radius:12px;padding:12px;margin-bottom:12px}
h1{margin:0 0 10px;font-size:20px}
h2{margin:0 0 8px;font-size:15px}
label{font-size:13px;color:#444}
input,textarea{width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;font-size:13px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ddd;padding:6px;text-align:left}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:9999}
.box{background:#fff;padding:22px;border-radius:16px;width:420px}
.admin-only{display:none}
body.admin-mode .admin-only{display:block}
</style>
</head>

<body>

<!-- LANDING -->
<div id="landing" class="overlay">
  <div class="box">
    <h2>Welcome</h2>
    <p>Select how you would like to use the prescription builder.</p>
    <button class="btn" id="enterPrescriber">Prescriber Mode</button><br><br>
    <button class="btn" id="enterAdmin">Admin Mode</button>
  </div>
</div>

<!-- LOGIN -->
<div id="loginOverlay" class="overlay hidden">
  <div class="box">
    <h2 id="loginTitle">Login</h2>
    <p id="loginSubtitle"></p>

    <label>Email</label>
    <input id="loginEmail" type="email">

    <label>Password</label>
    <input id="loginPassword" type="password">

    <div id="loginError" style="color:#b00020;font-size:13px;display:none"></div>

    <br>
    <button class="btn" id="loginSignIn">Sign in</button>
    <button class="btn" id="loginSignUp">Create account</button>
    <button class="btn" id="loginBack">← Back</button>
  </div>
</div>

<!-- MAIN APP -->
<div class="page hidden" id="app">
  <h1>Melasma Prescription Builder</h1>

  <!-- ADMIN PANEL -->
  <div class="card admin-only">
    <h2>Admin – Prescribers using this form</h2>
    <button class="btn" id="loadPrescribers">Refresh list</button>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Address</th>
          <th>Contact</th>
          <th>Prescriber #</th>
        </tr>
      </thead>
      <tbody id="prescriberTable">
        <tr><td colspan="4">No data</td></tr>
      </tbody>
    </table>
  </div>

  <!-- PRESCRIPTION FORM -->
  <div class="card">
    <h2>Prescription Formula</h2>
    <p>This is where your full prescription builder will live.</p>
    <p style="color:#666;font-size:13px">
      (Your ingredient tables, dosing logic, pricing, print layout etc will sit here.)
    </p>
  </div>

  <button class="btn" id="logoutBtn">Log out</button>
</div>

<script>
"use strict";

/* SUPABASE CONFIG – KEEP QUOTES */
var SUPABASE_URL = "https://ogzruhymglenzwizmggd.supabase.co";
var SUPABASE_KEY = "sb_publishable_VudO6SBFp9kzL2YIkSeTQA_dP8jdGHC";

var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function el(id){return document.getElementById(id)}
function show(id,on){el(id).classList.toggle("hidden",!on)}

var mode = "prescriber";

/* AUTH */
async function signIn(){
  var email = el("loginEmail").value.trim();
  var password = el("loginPassword").value.trim();
  var err = el("loginError");
  err.style.display="none";

  var res = await sb.auth.signInWithPassword({email:email,password:password});
  if(res.error){
    err.textContent=res.error.message;
    err.style.display="block";
    return;
  }
  async function signUp(){
  var email = el("loginEmail").value.trim();
  var password = el("loginPassword").value.trim();
  var err = el("loginError");
  err.style.display="none";

  var res = await sb.auth.signUp({email:email,password:password});
  if(res.error){
    err.textContent=res.error.message;
    err.style.display="block";
    return;
  }

  // If email confirmations are OFF, user may already be signed in:
  afterLogin();
}

  afterLogin();
}

async function afterLogin(){
  var u = await sb.auth.getUser();
  if(!u.data.user) return;

  if(mode==="admin"){
    var check = await sb.from("admins").select("id").eq("id",u.data.user.id).maybeSingle();
    if(!check.data){
      await sb.auth.signOut();
      el("loginError").textContent="Not authorised as admin.";
      el("loginError").style.display="block";
      return;
    }
    document.body.classList.add("admin-mode");
  }else{
    document.body.classList.remove("admin-mode");
  }

  show("loginOverlay",false);
  show("landing",false);
  show("app",true);
}

/* ADMIN LIST */
async function loadPrescribers(){
  var body = el("prescriberTable");
  body.innerHTML="<tr><td colspan='4'>Loading…</td></tr>";
  var res = await sb.from("profiles")
    .select("prescriber_name,clinic_address,clinic_contact,prescriber_number")
    .limit(500);
  if(res.error){body.innerHTML="<tr><td colspan='4'>Error</td></tr>";return}
  if(!res.data.length){body.innerHTML="<tr><td colspan='4'>No data</td></tr>";return}
  var html="";
  for(var i=0;i<res.data.length;i++){
    var r=res.data[i];
    html+="<tr><td>"+(r.prescriber_name||"")+"</td><td>"+(r.clinic_address||"")+"</td><td>"+(r.clinic_contact||"")+"</td><td>"+(r.prescriber_number||"")+"</td></tr>";
  }
  body.innerHTML=html;
}

/* EVENTS */
document.addEventListener("DOMContentLoaded",function(){
  el("enterPrescriber").onclick=function(){
    mode="prescriber";
    el("loginTitle").textContent="Prescriber Login";
    el("loginSubtitle").textContent="Sign in to continue";
    show("landing",false);show("loginOverlay",true);
  };
  el("enterAdmin").onclick=function(){
    mode="admin";
    el("loginTitle").textContent="Admin Login";
    el("loginSubtitle").textContent="Admin accounts only";
    show("landing",false);show("loginOverlay",true);
  };
  el("loginSignIn").onclick=signIn;
  el("loginSignUp").onclick=signUp;
  el("loginBack").onclick=function(){show("loginOverlay",false);show("landing",true)};
  el("loadPrescribers").onclick=loadPrescribers;
  el("logoutBtn").onclick=async function(){
    await sb.auth.signOut();
    show("app",false);show("landing",true);
  };
});
</script>

</body>
</html>
