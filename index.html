<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Melasma Prescription Builder</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f3f3f3}
    .hidden{display:none !important}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:9999}
    .box{width:420px;max-width:calc(100% - 24px);background:#fff;border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
    .btn{border:1px solid #ccc;background:#fff;border-radius:999px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:#f1f1f1}
    input{width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;font-size:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row .btn{flex:1}
    #app{max-width:1100px;margin:18px auto;padding:16px;background:#fff;border-radius:16px}
    .err{margin-top:8px;color:#b00020;font-size:13px}
    table{width:100%;border-collapse:collapse;min-width:720px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left;font-size:13px}
  </style>
</head>

<body>

  <!-- Landing -->
  <div id="landing" class="overlay">
    <div class="box">
      <h2 style="margin:0 0 8px">Welcome</h2>
      <p style="margin:0 0 14px;color:#444">Choose how you want to use the builder.</p>
      <div class="row">
        <button id="goPrescriber" class="btn" type="button">Prescriber Mode</button>
        <button id="goAdmin" class="btn" type="button">Admin Mode</button>
      </div>
      <div style="margin-top:12px;color:#666;font-size:12px;line-height:1.35">
        Admin Mode requires an approved admin account in Supabase.
      </div>
    </div>
  </div>

  <!-- Login -->
  <div id="loginOverlay" class="overlay hidden">
    <div class="box">
      <h2 id="loginTitle" style="margin:0 0 8px">Login</h2>
      <p id="loginSubtitle" style="margin:0 0 14px;color:#444"></p>

      <div style="display:grid;gap:10px">
        <input id="loginEmail" type="email" placeholder="Email" autocomplete="email" />
        <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password" />
        <label style="display:flex;align-items:center;gap:8px;color:#444;font-size:13px;">
          <input id="showPwd" type="checkbox" />
          Show password
        </label>
      </div>

      <div id="loginError" class="err hidden"></div>

      <div class="row" style="margin-top:14px">
        <button id="loginSignIn" class="btn" type="button">Sign in</button>
        <button id="loginSignUp" class="btn" type="button">Create account</button>
      </div>
      <div style="margin-top:10px">
        <button id="loginBack" class="btn" type="button">← Back</button>
      </div>
    </div>
  </div>

  <!-- App -->
  <div id="app" class="hidden">
    <h1 style="margin:0 0 10px;font-size:20px">Melasma Prescription Builder</h1>
    <div id="modeBadge" style="color:#444;margin-bottom:10px"></div>

    <div id="adminPanel" class="hidden" style="border:1px dashed #ccc;border-radius:14px;padding:12px;margin-top:10px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div style="font-weight:700">Admin Panel</div>
        <button id="adminLoadPrescribers" class="btn" type="button">Load Prescribers</button>
      </div>
      <div id="adminErr" class="err hidden"></div>
      <div style="margin-top:10px;overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Address</th>
              <th>Contact</th>
              <th>Prescriber #</th>
            </tr>
          </thead>
          <tbody id="prescriberRows">
            <tr><td colspan="4" style="color:#666">Click “Load Prescribers”.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div style="margin-top:14px">
      <button id="logoutBtn" class="btn" type="button">Log out</button>
    </div>
  </div>

  <script>
    "use strict";

    // Supabase config (keep quotes!)
    var SUPABASE_URL = "https://ogzruhymglenzwizmggd.supabase.co";
    var SUPABASE_KEY = "sb_publishable_VudO6SBFp9kzL2YIkSeTQA_dP8jdGHC";

    var sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function el(id){ return document.getElementById(id); }
    function show(id, on){
      var node = el(id);
      if(!node) return;
      if(on) node.classList.remove("hidden");
      else node.classList.add("hidden");
    }
    function setText(id, t){
      var node = el(id);
      if(node) node.textContent = t;
    }
    function showErr(id, msg){
      var node = el(id);
      if(!node) return;
      if(msg){
        node.textContent = msg;
        node.classList.remove("hidden");
      }else{
        node.textContent = "";
        node.classList.add("hidden");
      }
    }

    var intent = "prescriber";

    async function afterLogin(){
      var userRes = await sb.auth.getUser();
      var user = userRes && userRes.data && userRes.data.user;
      if(!user) return;

      if(intent === "admin"){
        var adminRes = await sb.from("admins").select("id").eq("id", user.id).maybeSingle();
        if(adminRes.error || !adminRes.data){
          await sb.auth.signOut();
          showErr("loginError", "This account is not approved for admin access.");
          return;
        }
        show("adminPanel", true);
        setText("modeBadge", "Mode: ADMIN (approved)");
      }else{
        show("adminPanel", false);
        setText("modeBadge", "Mode: PRESCRIBER");
      }

      show("loginOverlay", false);
      show("landing", false);
      show("app", true);
    }

    async function signIn(){
      showErr("loginError", "");
      var email = (el("loginEmail").value || "").trim().toLowerCase();
      var password = (el("loginPassword").value || "").trim();

      var res = await sb.auth.signInWithPassword({ email: email, password: password });
      if(res.error){
        showErr("loginError", res.error.message || "Sign in failed.");
        return;
      }
      await afterLogin();
    }

    async function signUp(){
      showErr("loginError", "");
      var email = (el("loginEmail").value || "").trim().toLowerCase();
      var password = (el("loginPassword").value || "").trim();

      var res = await sb.auth.signUp({ email: email, password: password });
      if(res.error){
        showErr("loginError", res.error.message || "Sign up failed.");
        return;
      }

      // Try immediate sign-in (works if email confirmations are disabled)
      var res2 = await sb.auth.signInWithPassword({ email: email, password: password });
      if(res2.error){
        showErr("loginError", "Account created. If email confirmation is enabled, confirm via email then sign in.");
        return;
      }
      await afterLogin();
    }

    async function loadPrescribers(){
      showErr("adminErr", "");
      var body = el("prescriberRows");
      body.innerHTML = '<tr><td colspan="4" style="color:#666">Loading…</td></tr>';

      var res = await sb
        .from("profiles")
        .select("prescriber_name,clinic_address,clinic_contact,prescriber_number,updated_at")
        .order("updated_at", { ascending: false })
        .limit(500);

      if(res.error){
        showErr("adminErr", "Could not load list. Check admin policies for profiles.");
        body.innerHTML = '<tr><td colspan="4" style="color:#666">No data.</td></tr>';
        return;
      }

      var data = res.data || [];
      if(!data.length){
        body.innerHTML = '<tr><td colspan="4" style="color:#666">No profiles found.</td></tr>';
        return;
      }

      var html = "";
      for(var i=0;i<data.length;i++){
        var r = data[i] || {};
        html += "<tr>"
          + "<td>" + (r.prescriber_name || "") + "</td>"
          + "<td>" + (r.clinic_address || "") + "</td>"
          + "<td>" + (r.clinic_contact || "") + "</td>"
          + "<td>" + (r.prescriber_number || "") + "</td>"
          + "</tr>";
      }
      body.innerHTML = html;
    }

    document.addEventListener("DOMContentLoaded", function(){
      el("goPrescriber").addEventListener("click", function(){
        intent = "prescriber";
        setText("loginTitle", "Prescriber Login");
        setText("loginSubtitle", "Sign in with your prescriber account.");
        show("landing", false);
        show("loginOverlay", true);
      });

      el("goAdmin").addEventListener("click", function(){
        intent = "admin";
        setText("loginTitle", "Admin Login");
        setText("loginSubtitle", "Sign in with an approved admin account.");
        show("landing", false);
        show("loginOverlay", true);
      });

      el("loginSignIn").addEventListener("click", signIn);
      el("loginSignUp").addEventListener("click", signUp);

      el("loginBack").addEventListener("click", function(){
        showErr("loginError", "");
        show("loginOverlay", false);
        show("landing", true);
      });

      el("showPwd").addEventListener("change", function(e){
        el("loginPassword").type = e.target.checked ? "text" : "password";
      });

      el("adminLoadPrescribers").addEventListener("click", loadPrescribers);

      el("logoutBtn").addEventListener("click", async function(){
        await sb.auth.signOut();
        show("app", false);
        show("loginOverlay", false);
        show("landing", true);
      });
    });
  </script>

</body>
</html>
