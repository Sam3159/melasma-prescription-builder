<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://ogzruhymglenzwizmggd.supabase.co";
const SUPABASE_KEY = "sb_publishable_VudO6SBFp9kzL2YIkSeTQA_dP8jdGHC";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function $(id){ return document.getElementById(id); }
function show(id,on){ $(id).classList.toggle("hidden", !on); }
function setAdmin(on){ document.body.classList.toggle("admin-mode", !!on); }

let authIntent = "prescriber";

async function afterLogin(){
  const { data: { user } } = await sb.auth.getUser();
  if(!user) return;

  if(authIntent === "admin"){
    const { data } = await sb.from("admins").select("id").eq("id", user.id).maybeSingle();
    if(!data){
      await sb.auth.signOut();
      const err = $("loginError");
      err.textContent = "Not authorised as admin.";
      err.style.display = "block";
      return;
    }
    setAdmin(true);
  } else {
    setAdmin(false);
  }

  show("loginOverlay", false);
  show("landing", false);
  show("app", true);
}

async function signIn(){
  const err = $("loginError");
  err.style.display = "none";
  err.textContent = "";

  const email = $("loginEmail").value.trim();
  const password = $("loginPassword").value.trim();

  const { error } = await sb.auth.signInWithPassword({ email, password });
  if(error){
    err.textContent = error.message || "Sign in failed.";
    err.style.display = "block";
    return;
  }
  await afterLogin();
}

async function signUp(){
  const err = $("loginError");
  err.style.display = "none";
  err.textContent = "";

  const email = $("loginEmail").value.trim();
  const password = $("loginPassword").value.trim();

  const { error } = await sb.auth.signUp({ email, password });
  if(error){
    err.textContent = error.message || "Sign up failed.";
    err.style.display = "block";
    return;
  }

  // Attempt immediate sign-in (works if email confirmation disabled)
  const { error: e2 } = await sb.auth.signInWithPassword({ email, password });
  if(e2){
    err.textContent = "Account created. If email confirmation is enabled, confirm via email then sign in.";
    err.style.display = "block";
    return;
  }
  await afterLogin();
}

document.addEventListener("DOMContentLoaded", () => {

  const goPrescriber = document.getElementById("goPrescriber");
  if (goPrescriber) {
    goPrescriber.addEventListener("click", () => {
      authIntent = "prescriber";
      document.getElementById("loginTitle").textContent = "Prescriber Login";
      document.getElementById("loginSubtitle").textContent =
        "Sign in to access your saved profile";
      show("landing", false);
      show("loginOverlay", true);
    });
  }

  const goAdmin = document.getElementById("goAdmin");
  if (goAdmin) {
    goAdmin.addEventListener("click", () => {
      authIntent = "admin";
      document.getElementById("loginTitle").textContent = "Admin Login";
      document.getElementById("loginSubtitle").textContent =
        "Admin access requires approval";
      show("landing", false);
      show("loginOverlay", true);
    });
  }

  const loginSignIn = document.getElementById("loginSignIn");
  if (loginSignIn) {
    loginSignIn.addEventListener("click", signIn);
  }

  const loginSignUp = document.getElementById("loginSignUp");
  if (loginSignUp) {
    loginSignUp.addEventListener("click", signUp);
  }

  const loginBack = document.getElementById("loginBack");
  if (loginBack) {
    loginBack.addEventListener("click", () => {
      show("loginOverlay", false);
      show("landing", true);
    });
  }

  const loadBtn = document.getElementById("loadPrescribers");
  if (loadBtn) {
    loadBtn.addEventListener("click", loadPrescribers);
  }
});

</script>
